<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Elden Architect v17</title>
    
    <!-- THIS LINE LOADS YOUR DATABASE FILE -->
    <script src="data.js"></script>

    <style>
        /* --- VARIABLES & RESET --- */
        :root {
            --bg: #09090b; --panel: #18181b; --border: #27272a;
            --gold: #d4b483; --text: #e4e4e7; --text-dim: #a1a1aa;
            --green: #22c55e; --red: #ef4444; --blue: #3b82f6; --purple: #a855f7;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, system-ui, sans-serif; margin: 0; padding-bottom: 100px; }

        /* --- HEADER --- */
        header { background: rgba(9,9,11,0.95); border-bottom: 1px solid var(--border); padding: 15px; text-align: center; position: sticky; top: 0; z-index: 90; backdrop-filter: blur(10px); }
        h1 { margin: 0; font-size: 1.2rem; letter-spacing: 2px; color: var(--gold); text-transform: uppercase; }

        /* --- CONTAINER --- */
        .container { max-width: 700px; margin: 0 auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; }

        /* --- CARDS --- */
        .card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 16px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 15px; font-weight: 700; color: var(--gold); font-size: 0.8rem; text-transform: uppercase; }

        /* --- INPUTS --- */
        label { display: block; color: var(--text-dim); font-size: 0.7rem; margin-bottom: 5px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        select, input { width: 100%; background: #0f0f11; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 6px; font-size: 1rem; appearance: none; }
        select { background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23d4b483%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 12px center; background-size: 10px; }
        select:disabled { opacity: 0.5; color: #555; border-color: #333; }

        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .flex-row { display: flex; gap: 10px; align-items: flex-end; }

        /* --- BUTTONS --- */
        .loc-btn {
            background: #222; border: 1px solid var(--border); color: var(--gold);
            padding: 10px 12px; border-radius: 6px; font-size: 0.9rem; cursor: pointer;
            white-space: nowrap;
        }
        .loc-btn:active { background: var(--gold); color: black; }

        /* --- INFO PANEL --- */
        .selection-intel {
            margin-top: 8px; padding: 10px;
            background: #222; border-left: 3px solid var(--blue);
            color: #ccc; font-size: 0.85rem; line-height: 1.4;
            border-radius: 0 4px 4px 0;
            display: none; 
        }
        .selection-intel.active { display: block; animation: fadeIn 0.3s; }
        .intel-scale { color: var(--gold); font-weight: bold; margin-right: 10px; font-family: monospace; }
        .intel-desc { font-style: italic; color: #aaa; }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 100;
            display: none; align-items: center; justify-content: center;
            padding: 20px;
        }
        .modal-content {
            background: #18181b; border: 1px solid var(--gold); border-radius: 12px;
            width: 100%; max-width: 500px; overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .modal-header {
            padding: 15px; background: #222; border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-title { color: var(--gold); font-weight: bold; text-transform: uppercase; }
        .close-btn { background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer; }
        .modal-body { padding: 20px; color: #ddd; font-size: 0.95rem; line-height: 1.5; }
        .video-btn {
            display: block; width: 100%; text-align: center; background: #cc0000; color: white;
            padding: 12px; border-radius: 8px; text-decoration: none; font-weight: bold; margin-top: 15px;
        }

        /* --- OPTIONAL TOGGLE --- */
        details { background: #111; border-radius: 8px; overflow: hidden; margin-bottom: 15px; border: 1px solid var(--border); }
        summary { padding: 10px; cursor: pointer; font-size: 0.8rem; color: var(--text-dim); user-select: none; display: flex; align-items: center; justify-content: space-between; }
        summary::after { content: '+'; font-size: 1.2rem; }
        details[open] summary::after { content: '-'; }
        details[open] summary { border-bottom: 1px solid var(--border); }
        .opt-content { padding: 15px; }

        /* --- RESULTS --- */
        .tier-banner { padding: 15px; text-align: center; font-weight: 800; font-size: 1.3rem; text-transform: uppercase; border-radius: 8px; margin-bottom: 15px; border: 1px solid transparent; }
        .tier-s { background: rgba(34,197,94,0.1); color: var(--green); border-color: var(--green); }
        .tier-a { background: rgba(212,180,131,0.1); color: var(--gold); border-color: var(--gold); }
        .tier-c { background: rgba(239,68,68,0.1); color: var(--red); border-color: var(--red); }

        .analysis-box { background: #202023; border-left: 4px solid #555; padding: 12px; margin-top: 10px; border-radius: 0 6px 6px 0; }
        .box-title { font-size: 0.7rem; text-transform: uppercase; font-weight: 700; margin-bottom: 4px; opacity: 0.8; }
        .rec-box { background: rgba(59,130,246,0.1); border: 1px solid var(--blue); padding: 12px; border-radius: 8px; margin-top: 15px; }
        
        /* --- VERDICT --- */
        .verdict-box { background: #111; border: 1px solid var(--gold); padding: 15px; border-radius: 8px; margin-top: 20px; }
        .verdict-score { font-size: 2rem; font-weight: 900; color: var(--gold); display: block; text-align: center; margin-bottom: 10px; }
        
        /* --- TAGS --- */
        .tag-cloud { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 15px; }
        .tag { padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; background: #222; color: #888; }
        .t-weak { background: #064e3b; color: #6ee7b7; }
        .t-resist { background: #450a0a; color: #fca5a5; }

        /* --- TABS --- */
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: rgba(9,9,11,0.98); border-top: 1px solid var(--border); display: flex; padding: 10px 0 20px; z-index: 99; }
        .nav-item { flex: 1; text-align: center; color: var(--text-dim); font-size: 0.7rem; cursor: pointer; }
        .nav-item.active { color: var(--gold); }
        .nav-icon { font-size: 1.4rem; display: block; margin-bottom: 3px; }
        .view { display: none; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #lib-list div { padding: 12px; border-bottom: 1px solid #333; cursor: pointer; }
        #lib-list div:hover { background: #222; }
    </style>
</head>
<body>

<header>
    <h1>Elden Architect</h1>
</header>

<div class="container">

    <!-- CALCULATOR VIEW -->
    <div id="view-build" class="view active">
        
        <!-- STATS -->
        <div class="card">
            <div class="card-header"><span>Attributes</span><span>Level <span id="lvl">1</span></span></div>
            <div class="stats-grid">
                <div><label>VIG</label><input type="number" id="vig" value="40"></div>
                <div><label>MND</label><input type="number" id="mnd" value="20"></div>
                <div><label>END</label><input type="number" id="end" value="25"></div>
                <div><label>STR</label><input type="number" id="str" value="18"></div>
                <div><label>DEX</label><input type="number" id="dex" value="40"></div>
                <div><label>INT</label><input type="number" id="int" value="9"></div>
                <div><label>FAI</label><input type="number" id="fai" value="15"></div>
                <div><label>ARC</label><input type="number" id="arc" value="45"></div>
            </div>
        </div>

        <!-- LOADOUT -->
        <div class="card">
            <div class="card-header">Combat Setup</div>
            
            <!-- BOSS SELECT -->
            <div style="margin-bottom:20px;">
                <label style="color:var(--red)">Primary Target (Boss)</label>
                <select id="boss"></select>
                <div id="boss-rec-box" class="rec-box" style="margin-top:10px; display:none;"></div>
            </div>

            <div style="margin-bottom:10px">
                <label>Main Weapon</label>
                <div class="flex-row">
                    <select id="weapon"></select>
                    <button class="loc-btn" onclick="openLoc('weapon')">üìç Where?</button>
                </div>
                <div id="info-weapon" class="selection-intel"></div>
            </div>
            
            <div class="row-2">
                <div>
                    <label>Affinity</label>
                    <select id="affinity"></select>
                </div>
                <div>
                    <label>Ash of War</label>
                    <div class="flex-row">
                        <select id="ash"></select>
                        <button class="loc-btn" onclick="openLoc('ash')">üìç</button>
                    </div>
                </div>
            </div>
            
            <!-- Extra Info Panels for Affinity/Ash -->
            <div id="info-affinity" class="selection-intel" style="margin-bottom:10px"></div>
            <div id="info-ash" class="selection-intel" style="margin-bottom:10px"></div>

            <div style="margin-bottom:15px"><label style="color:var(--blue)">Playstyle</label>
                <select id="style">
                    <option value="bal">Balanced / Reactive</option>
                    <option value="skill">Skill Master (L2 Spam)</option>
                    <option value="aggro">Aggressive (R1 Mash)</option>
                    <option value="jump">Jump Attacker</option>
                    <option value="guard">Guard Counter (Shield)</option>
                    <option value="poke">Shield Poke / Hit & Run</option>
                    <option value="parry">Parry King</option>
                </select>
            </div>

            <!-- AUTO-RECOMMENDED TALISMANS -->
            <div class="analysis-box" style="border-color:var(--purple)">
                <div class="box-title" style="color:var(--purple)">Recommended Talismans</div>
                <div id="rec-tals" style="font-size:0.9rem">Select a weapon to see recommendations.</div>
            </div>

            <details style="margin-top:15px">
                <summary>Advanced (Shields/Grease/Talisman)</summary>
                <div class="opt-content">
                    <div style="margin-bottom:15px">
                        <label>Offhand Shield</label>
                        <div class="flex-row">
                            <select id="shield"><option value="">None / Two-Handing</option></select>
                            <button class="loc-btn" onclick="openLoc('shield')">üìç</button>
                        </div>
                        <div id="info-shield" class="selection-intel"></div>
                    </div>
                    
                    <!-- TALISMANS -->
                    <div class="row-2">
                        <div>
                            <label>Talisman 1</label>
                            <div class="flex-row">
                                <select id="tal-0" class="tal"><option value="">None</option></select>
                                <button class="loc-btn" onclick="openLoc('tal-0')">üìç</button>
                            </div>
                        </div>
                        <div>
                            <label>Talisman 2</label>
                            <div class="flex-row">
                                <select id="tal-1" class="tal"><option value="">None</option></select>
                                <button class="loc-btn" onclick="openLoc('tal-1')">üìç</button>
                            </div>
                        </div>
                    </div>
                    <div class="row-2">
                        <div>
                            <label>Talisman 3</label>
                            <div class="flex-row">
                                <select id="tal-2" class="tal"><option value="">None</option></select>
                                <button class="loc-btn" onclick="openLoc('tal-2')">üìç</button>
                            </div>
                        </div>
                        <div>
                            <label>Talisman 4</label>
                            <div class="flex-row">
                                <select id="tal-3" class="tal"><option value="">None</option></select>
                                <button class="loc-btn" onclick="openLoc('tal-3')">üìç</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="tal-info-box" class="selection-intel" style="margin-bottom:10px"></div>

                    <div class="row-2">
                        <div>
                            <label>Buff / Spell</label>
                            <div class="flex-row">
                                <select id="buff"><option value="">None</option></select>
                                <button class="loc-btn" onclick="openLoc('buff')">üìç</button>
                            </div>
                        </div>
                        <div>
                            <label>Grease (Weapon Coat)</label>
                            <select id="grease"></select>
                        </div>
                    </div>
                </div>
            </details>
        </div>

        <!-- ANALYSIS RESULTS -->
        <div class="card">
            <div class="card-header">Combat Analysis</div>
            
            <div id="tier" class="tier-banner">Loading...</div>
            
            <div id="tags" class="tag-cloud"></div>

            <div id="results"></div>
            
            <!-- FINAL VERDICT -->
            <div class="verdict-box">
                <div class="box-title" style="color:var(--gold); text-align:center;">Final Verdict</div>
                <span id="v-score" class="verdict-score">85%</span>
                <p id="v-text" style="text-align:justify; font-size:0.9rem; line-height:1.5; color:#ccc;"></p>
            </div>
        </div>
        
        <div style="height:50px"></div>
    </div>

    <!-- LIBRARY VIEW -->
    <div id="view-lib" class="view">
        <div class="card">
            <div class="card-header">Weapon Database</div>
            <input type="text" id="search" placeholder="Search 200+ Items..." style="margin-bottom:10px">
            <div id="lib-list"></div>
        </div>
    </div>

</div>

<!-- MODAL -->
<div id="modal" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal-content">
        <div class="modal-header">
            <span class="modal-title">Location Intel</span>
            <button class="close-btn" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body" id="modal-body">
            <!-- Content Injected Here -->
        </div>
    </div>
</div>

<!-- NAV -->
<div class="nav-bar">
    <div class="nav-item active" onclick="switchTab('build')">
        <span class="nav-icon">‚öîÔ∏è</span>Build
    </div>
    <div class="nav-item" onclick="switchTab('lib')">
        <span class="nav-icon">üìñ</span>Library
    </div>
</div>

<script>
/* --- LOGIC --- */
function sortByName(a, b) { return a.name.localeCompare(b.name); }

document.addEventListener('DOMContentLoaded', () => {
    // Check if DB is loaded
    if (typeof DB === 'undefined') {
        alert("Database not loaded! Make sure 'data.js' is in the same folder.");
        return;
    }

    // Sort Data
    DB.weapons.sort(sortByName); DB.bosses.sort(sortByName);
    
    fillSelect('weapon', DB.weapons);
    fillSelect('boss', DB.bosses);
    fillSelect('affinity', DB.affinities);
    fillSelect('ash', DB.ashes);
    fillSelect('shield', DB.shields);
    fillSelect('buff', DB.buffs);
    fillSelect('grease', DB.greases);
    
    document.querySelectorAll('.tal').forEach(s => {
        s.innerHTML = '<option value="">None</option>';
        DB.talismans.forEach(t => {
            const o = document.createElement('option');
            o.value = t.id; o.innerText = t.name; s.appendChild(o);
        });
    });

    document.querySelectorAll('input, select').forEach(el => {
        if(el.id === 'weapon') el.addEventListener('change', handleWeaponChange);
        else if(el.id === 'affinity') el.addEventListener('change', updateGreaseLock);
        else if(el.id === 'search') el.addEventListener('keyup', renderLib);
        else if(el.id === 'ash') el.addEventListener('change', () => showInfo('info-ash', DB.ashes.find(x=>x.id===el.value)));
        else if(el.id === 'shield') el.addEventListener('change', () => showInfo('info-shield', DB.shields.find(x=>x.id===el.value)));
        else el.addEventListener('change', update);
    });

    // Listener for talismans to update intel box
    document.querySelectorAll('.tal').forEach(sel => {
        sel.addEventListener('change', () => {
            const t = DB.talismans.find(x => x.id === sel.value);
            const box = document.getElementById('tal-info-box');
            if(t) {
                box.innerHTML = `<span class="intel-scale">${t.name}</span><span class="intel-desc">${t.desc}</span>`;
                box.classList.add('active');
            } else {
                box.classList.remove('active');
            }
            update();
        });
    });

    // Default
    document.getElementById('weapon').value = 'rob';
    document.getElementById('boss').value = 'malenia';
    handleWeaponChange();
});

function fillSelect(id, arr) {
    const el = document.getElementById(id);
    el.innerHTML = '';
    arr.forEach(i => {
        const o = document.createElement('option');
        o.value = i.id; o.innerText = i.name; el.appendChild(o);
    });
}

/* --- INFO PANEL --- */
function showInfo(id, item, scaleText) {
    const el = document.getElementById(id);
    if (item) {
        let html = "";
        if (scaleText) html += `<span class="intel-scale">${scaleText}</span>`;
        if (item.desc) html += `<span class="intel-desc">${item.desc}</span>`;
        el.innerHTML = html;
        el.classList.add('active');
    } else {
        el.classList.remove('active');
        el.innerHTML = "";
    }
}

function openLoc(type) {
    const selectEl = type.startsWith('tal-') ? document.getElementById(type) : document.getElementById(type);
    const id = selectEl.value;
    let item;
    
    if (type === 'weapon') item = DB.weapons.find(x => x.id === id);
    else if (type === 'shield') item = DB.shields.find(x => x.id === id);
    else if (type === 'buff') item = DB.buffs.find(x => x.id === id);
    else if (type === 'ash') item = DB.ashes.find(x => x.id === id);
    else if (type.startsWith('tal-')) item = DB.talismans.find(x => x.id === id);

    const modal = document.getElementById('modal');
    const body = document.getElementById('modal-body');

    if (!item || !item.loc) {
        body.innerHTML = "Please select an item first.";
    } else {
        const searchUrl = `https://www.youtube.com/results?search_query=Elden+Ring+${item.name.replace(/ /g, '+')}+location`;
        body.innerHTML = `
            <div style="font-weight:bold; color:var(--gold); margin-bottom:10px; font-size:1.1rem;">${item.name}</div>
            <div style="margin-bottom:15px;">${item.loc}</div>
            <a href="${searchUrl}" target="_blank" class="video-btn">üì∫ Watch Location Guide</a>
        `;
    }
    modal.style.display = 'flex';
}

function closeModal(e) {
    if (!e || e.target.id === 'modal' || e.target.classList.contains('close-btn')) {
        document.getElementById('modal').style.display = 'none';
    }
}

function handleWeaponChange() {
    const w = DB.weapons.find(x => x.id === document.getElementById('weapon').value);
    const aff = document.getElementById('affinity');
    const ash = document.getElementById('ash');

    if(w.type === 'Somber') {
        aff.innerHTML = '<option value="somber">Unique</option>'; aff.disabled = true;
        ash.innerHTML = `<option value="fixed">${w.skill}</option>`; ash.disabled = true;
        
        // Show Somber Info
        let scaleTxt = "";
        if(w.scale) {
            scaleTxt = Object.entries(w.scale).map(([k,v]) => `${k.toUpperCase()} ${v}`).join(' / ');
        }
        showInfo('info-weapon', w, scaleTxt);
        document.getElementById('info-affinity').classList.remove('active');
        document.getElementById('info-ash').classList.remove('active');

    } else {
        aff.disabled = false; ash.disabled = false;
        fillSelect('affinity', DB.affinities);
        fillSelect('ash', DB.ashes);
        // Default Logic
        if(w.name.includes('Katana')) { aff.value='keen'; ash.value='unsheathe'; }
        else if(w.dmg.includes('Strike')) { aff.value='heavy'; ash.value='lion'; }
        else { aff.value='std'; ash.value='lion'; }
        
        // Initial Std Info
        showInfo('info-weapon', w);
        updateGreaseLock(); // Will trigger info update for affinity
    }
    updateGreaseLock();
    update();
}

function updateGreaseLock() {
    const w = DB.weapons.find(x => x.id === document.getElementById('weapon').value);
    const affId = document.getElementById('affinity').value;
    const greaseSel = document.getElementById('grease');

    let canGrease = false;
    let scaleTxt = "";

    if (w.type === 'Somber') {
        canGrease = w.buffable;
        if(w.scale) scaleTxt = Object.entries(w.scale).map(([k,v]) => `${k.toUpperCase()} ${v}`).join(' / ');
        showInfo('info-weapon', w, scaleTxt);
    } else {
        const aff = DB.affinities.find(x => x.id === affId);
        if (aff) {
            canGrease = aff.canBuff;
            showInfo('info-affinity', aff);
            
            // Calc Approx Scale
            let sStr='-', sDex='-', sInt='-', sFai='-', sArc='-';
            if(w.stats.includes('str')) sStr = 'C'; 
            if(w.stats.includes('dex')) sDex = 'C';
            
            if(aff.id === 'heavy') { sStr = 'A'; sDex = 'E'; }
            if(aff.id === 'keen') { sDex = 'A'; sStr = 'E'; }
            if(aff.id === 'qual') { sStr = 'B'; sDex = 'B'; }
            if(aff.type === 'Magic') { sInt = 'B'; sStr='D'; sDex='D'; }
            if(aff.type === 'Fire') { sStr = 'B'; } 
            if(aff.type === 'Lightning') { sDex = 'B'; }
            if(aff.type === 'Holy') { sFai = 'B'; }
            if(aff.id === 'blood' || aff.id === 'occult') { sArc = 'B'; }

            let parts = [];
            if(sStr!='-') parts.push(`STR ${sStr}`);
            if(sDex!='-') parts.push(`DEX ${sDex}`);
            if(sInt!='-') parts.push(`INT ${sInt}`);
            if(sFai!='-') parts.push(`FAI ${sFai}`);
            if(sArc!='-') parts.push(`ARC ${sArc}`);
            
            showInfo('info-weapon', w, parts.join(' / '));
        }
    }

    greaseSel.disabled = !canGrease;
    if (!canGrease) greaseSel.value = "";
}

function update() {
    const s = {};
    ['vig','mnd','end','str','dex','int','fai','arc'].forEach(k => s[k] = parseInt(document.getElementById(k).value)||0);
    document.getElementById('lvl').innerText = Object.values(s).reduce((a,b)=>a+b,0)-79;

    const w = DB.weapons.find(x => x.id === document.getElementById('weapon').value);
    const b = DB.bosses.find(x => x.id === document.getElementById('boss').value);
    const style = document.getElementById('style').value;
    
    // --- RECOMMENDED TALISMANS ---
    const recTals = document.getElementById('rec-tals');
    let tals = [];
    if(w.bleed) tals.push("Lord of Blood's Exultation (Bleed)");
    if(w.skill && w.type==='Somber') tals.push("Shard of Alexander (Skill Dmg)");
    if(style === 'jump') tals.push("Claw Talisman (Jump Atk)");
    if(style === 'guard') tals.push("Curved Sword Talisman (Guard Counter)");
    if(s.str < 20 && w.stats.includes('str')) tals.push("Starscourge Heirloom (+5 Str)");
    if(tals.length === 0) tals.push("Dragoncrest Greatshield (Defense)", "Green Turtle (Stamina)");
    recTals.innerHTML = `<ul>${tals.map(t=>`<li>${t}</li>`).join('')}</ul>`;

    // --- RECOMMENDED WEAPONS (BOSS SPECIFIC) ---
    const bossRecBox = document.getElementById('boss-rec-box');
    let recWeaps = [];
    if(b.weak.includes('Fire')) recWeaps.push("Blasphemous Blade", "Rivers of Blood", "Magma Blade");
    if(b.weak.includes('Strike')) recWeaps.push("Giant-Crusher", "Star Fist", "Great Mace");
    if(b.weak.includes('Pierce')) recWeaps.push("Bolt of Gransax", "Cross-Naginata");
    if(b.weak.includes('Holy')) recWeaps.push("Ordovis's Greatsword", "Black Knife");
    if(b.id === 'rykard') recWeaps = ["Serpent-Hunter (Required)"];
    
    bossRecBox.style.display = 'block';
    bossRecBox.innerHTML = `<div class="box-title" style="color:var(--blue)">Top Counters vs ${b.name}</div>` + 
                           recWeaps.map(n=>`<span class="tag">${n}</span>`).join(' ');

    // --- MATCHUP LOGIC ---
    let aff;
    if(w.type === 'Somber') aff = { id:'somber', type: w.dmg.split('/')[1]||'Phys' };
    else {
        const currentAffType = DB.affinities.find(x => x.id === document.getElementById('affinity').value);
        aff = currentAffType || { id:'std', type:'Phys' };
    }

    let score = 0;
    let logs = [];
    let warn = [];

    const currentAffType = aff.type || 'Phys';
    const dType = (w.type==='Somber' ? w.dmg : (currentAffType==='Phys' ? w.dmg : currentAffType));
    const isBleed = w.bleed || aff.effect === 'Bleed' || aff.id === 'blood';

    if(dType.includes('Fire')) {
        if(b.weak.includes('Fire')) { score+=2; logs.push("üî• Boss weak to Fire"); }
        if(b.resist.includes('Fire')) { score-=2; warn.push("Boss resists Fire."); }
    }
    if(dType.includes('Holy')) {
        if(b.weak.includes('Holy')) { score+=2; logs.push("‚ú® Boss weak to Holy"); }
        if(b.resist.includes('Holy')) { score-=3; warn.push("Boss heavily resists Holy."); }
    }
    if(dType.includes('Strike') && b.weak.includes('Strike')) { score+=1; logs.push("üî® Strike breaks armor"); }
    
    if(isBleed) {
        if(b.weak.includes('Bleed')) { score+=2; logs.push("ü©∏ Boss bleeds easily"); }
        if(b.resist.includes('Bleed')) { score-=2; warn.push("Boss immune/resist Bleed."); }
    }

    // Verdict Engine
    const shieldVal = document.getElementById('shield').value;
    const hasShield = shieldVal !== "";
    
    let vText = `You are running a <b>${w.name}</b> build. `;
    if (score >= 2) vText += `Excellent choice against ${b.name}. `;
    else if (score <= -2) vText += `This matchup is tough. ${b.name} resists your damage type. `;
    
    if (isBleed && b.weak.includes('Bleed')) vText += "Your Bleed will shred their HP bar. ";
    if (!hasShield && b.id === 'radahn_dlc') vText += "Consider a Greatshield for safety. ";
    
    document.getElementById('v-score').innerText = Math.max(0, Math.min(100, 50 + (score*15))) + "%";
    document.getElementById('v-text').innerHTML = vText;

    // Render Output
    const tierEl = document.getElementById('tier');
    tierEl.className = `tier-banner ${score>=2 ? 'tier-s' : (score>=0 ? 'tier-a' : 'tier-c')}`;
    tierEl.innerText = score>=2 ? "S-TIER (Excellent)" : (score>=0 ? "A-TIER (Solid)" : "C-TIER (Disadvantage)");

    const tBox = document.getElementById('tags');
    tBox.innerHTML = b.weak.map(t=>`<span class="tag t-weak">Weak: ${t}</span>`).join('') + 
                     b.resist.map(t=>`<span class="tag t-resist">Resist: ${t}</span>`).join('');

    const resBox = document.getElementById('results');
    resBox.innerHTML = '';

    if(warn.length) resBox.innerHTML += `<div class="analysis-box" style="border-color:var(--red)"><div class="box-title" style="color:var(--red)">Warnings</div>${warn.join('<br>')}</div>`;
    if(logs.length) resBox.innerHTML += `<div class="analysis-box" style="border-color:var(--gold)"><div class="box-title" style="color:var(--gold)">Matchup Intel</div>${logs.join('<br>')}</div>`;
    
    resBox.innerHTML += `<div class="analysis-box" style="border-color:#555"><div class="box-title">Boss Strategy</div>"${b.tip}"</div>`;
}

function switchTab(t) {
    document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
    document.getElementById('view-'+t).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
    event.currentTarget.classList.add('active');
}

function renderLib() {
    const q = document.getElementById('search').value.toLowerCase();
    const list = document.getElementById('lib-list');
    list.innerHTML = '';
    DB.weapons.filter(w => w.name.toLowerCase().includes(q)).forEach(w => {
        const d = document.createElement('div');
        d.innerHTML = `<b style="color:#fff">${w.name}</b><br><small style="color:#777">${w.type} | ${w.loc}</small>`;
        d.onclick = () => {
            document.getElementById('weapon').value = w.id;
            handleWeaponChange();
            switchTab('build');
        };
        list.appendChild(d);
    });
}
</script>
</body>
</html>
